version: 2.1

executors:
  php-executor:
    docker:
      - image: cimg/php:8.2-node
      - image: circleci/mysql:5.7
    working_directory: ~/repo
    environment:
      MYSQL_HOST: 127.0.0.1
      MYSQL_USER: root
      MYSQL_PASSWORD: root
      MYSQL_DATABASE: symfony_test

jobs:
  checkout_code:
    docker:
      - image: cimg/php:8.2-node
    steps:
      - checkout
      - run: echo "Hello, world"

  composer_install:
    docker:
      - image: cimg/php:8.2-node
    steps:
      - checkout
      - run:
          name: Install Composer Dependencies
          command: composer install --prefer-dist --no-interaction --optimize-autoloader
          
  run_tests:
    docker:
      - image: cimg/php:8.2-node
      - image: circleci/mysql:5.7  # Add MySQL service
    environment:
      MYSQL_HOST: 127.0.0.1
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: symfony_test
    steps:
      - checkout
      - run:
          name: Wait for MySQL to be ready
          command: |
            for i in `seq 1 30`; do
              nc -z 127.0.0.1 3306 && echo Success && exit 0
              echo -n .
              sleep 1
            done
            echo "MySQL did not start in time" && exit 1
      - run:
          name: Create Database (if necessary)
          command: |
            mysql -u root -proot -h 127.0.0.1 -e 'CREATE DATABASE IF NOT EXISTS symfony_test;'
      - run:
          name: Run PHPUnit Tests
          command: ./vendor/bin/phpunit --coverage-text

  run_lint:
    docker:
      - image: cimg/php:8.2-node
    steps:
      - checkout
      - run:
          name: Run PHPLint
          command: ./vendor/bin/phplint

  run_phpstan:
    docker:
      - image: cimg/php:8.2-node
    steps:
      - checkout
      - run:
          name: Run PHPStan
          command: ./vendor/bin/phpstan analyse

workflows:
  test_deploy:
    jobs:
      - checkout_code:
          filters:
            branches:
              only:
                - develop
                - UAT
                - master
      - composer_install:
          requires:
            - checkout_code
          filters:
            branches:
              only:
                - develop
                - UAT
                - master
      - run_tests:
          requires:
            - composer_install
          filters:
            branches:
              only:
                - develop
                - UAT
                - master
      - run_lint:
          requires:
            - run_tests
          filters:
            branches:
              only:
                - develop
                - UAT
                - master
      - run_phpstan:
          requires:
            - run_tests
          filters:
            branches:
              only:
                - develop
                - UAT
                - master
